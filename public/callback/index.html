<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonos Verbinden - Workout Timer</title>
    <script>
      (function() {
        var l = window.location;
        var params = l.search;
        var code = new URLSearchParams(params).get('code');
        var state = new URLSearchParams(params).get('state');
        var error = new URLSearchParams(params).get('error');
        
        // Check of we in een Capacitor app zijn (WebView)
        var isCapacitor = false;
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (typeof window.Capacitor !== 'undefined' || 
            window.navigator.userAgent.indexOf('Capacitor') !== -1 ||
            window.navigator.userAgent.indexOf('Workout Timer') !== -1 ||
            (window.webkit && window.webkit.messageHandlers)) {
          isCapacitor = true;
        }
        
        console.log('Callback page - isCapacitor:', isCapacitor, 'isIOS:', isIOS, 'params:', params);
        
        if (isCapacitor && isIOS && (code || error)) {
          // In iOS app: redirect naar custom URL scheme zodat Capacitor App plugin het kan vangen
          var deepLink = 'workouttimer://sonos/callback' + params;
          console.log('Redirecting to deep link:', deepLink);
          
          // Probeer de deep link te openen
          // Dit zal de app openen via de custom URL scheme
          window.location.href = deepLink;
          
          // Fallback: als deep link niet werkt na 2 seconden, gebruik localStorage bridge
          setTimeout(function() {
            if (window.location.href.indexOf('callback') !== -1) {
              console.log('Deep link fallback: using localStorage bridge');
              if (code) localStorage.setItem('sonos_callback_code', code);
              if (state) localStorage.setItem('sonos_callback_state', state);
              if (error) localStorage.setItem('sonos_callback_error', error);
              localStorage.setItem('sonos_callback_timestamp', Date.now().toString());
              l.replace('/');
            }
          }, 2000);
        } else if (isCapacitor && (code || error)) {
          // Andere platforms (Android): gebruik localStorage bridge
          if (code) localStorage.setItem('sonos_callback_code', code);
          if (state) localStorage.setItem('sonos_callback_state', state);
          if (error) localStorage.setItem('sonos_callback_error', error);
          localStorage.setItem('sonos_callback_timestamp', Date.now().toString());
          l.replace('/');
        } else {
          // Web versie: redirect naar web app met params
          var basePath = '/workout-timer/';
          l.replace(
            l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
            basePath +
            params +
            (l.hash || '')
          );
        }
      })();
    </script>
  </head>
  <body>
    <p>Verbinden met Sonos...</p>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonos Verbinden - Workout Timer</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        text-align: center;
        max-width: 400px;
      }
      .message {
        font-size: 16px;
        color: #333;
        margin-bottom: 20px;
      }
      .button {
        background: #007AFF;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .button:hover {
        background: #0056CC;
      }
    </style>
    <script>
      (function() {
        // Log callback URL (alleen in dev)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('[Sonos Callback] Full URL:', window.location.href);
          console.log('[Sonos Callback] Query params:', window.location.search);
        }

        // Parse query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        // Log parsed params (alleen in dev)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('[Sonos Callback] Parsed params:', { code: code ? '***' : null, state, error });
        }

        // Check if running in Capacitor iOS
        // Detect iOS via user agent (Capacitor apps hebben specifieke user agent)
        const userAgent = navigator.userAgent;
        const isIOS = /iPhone|iPad|iPod/.test(userAgent) || 
                     (userAgent.includes('Capacitor') && userAgent.includes('iPhone')) ||
                     (userAgent.includes('Capacitor') && userAgent.includes('iPad'));

        if (isIOS) {
          // Build deep link URL with same query params
          const deepLinkParams = new URLSearchParams();
          if (code) deepLinkParams.set('code', code);
          if (state) deepLinkParams.set('state', state);
          if (error) deepLinkParams.set('error', error);

          const deepLinkUrl = 'workouttimer://sonos/callback?' + deepLinkParams.toString();

          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('[Sonos Callback] iOS detected, redirecting to deep link:', deepLinkUrl);
          }

          // Try to redirect immediately
          window.location.href = deepLinkUrl;

          // Show fallback UI
          document.addEventListener('DOMContentLoaded', function() {
            const container = document.querySelector('.container');
            if (container) {
              container.innerHTML = '<p class="message">Opening the appâ€¦</p><a href="' + deepLinkUrl + '" class="button">Open app</a>';
            }
          });
        } else {
          // Web: redirect to main app with callback params preserved
          const l = window.location;
          const basePath = '/workout-timer/';
          l.replace(
            l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
            basePath +
            (l.search ? l.search : '') +
            l.hash
          );
        }
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <p class="message">Verbinden met Sonos...</p>
    </div>
  </body>
</html>

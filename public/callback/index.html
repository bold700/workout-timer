<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonos Verbinden - Workout Timer</title>
    <script>
      (function() {
        var l = window.location;
        var params = l.search;
        
        // Detecteer of we in een Capacitor app zijn
        var isCapacitor = false;
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        var isAndroid = /Android/.test(navigator.userAgent);
        
        // Check 1: User agent bevat vaak "Capacitor" of "Workout Timer"
        if (navigator.userAgent.indexOf('Capacitor') !== -1 || 
            navigator.userAgent.indexOf('Workout Timer') !== -1 ||
            navigator.userAgent.indexOf('ionic') !== -1) {
          isCapacitor = true;
        }
        
        // Check 2: Probeer Capacitor bridge te detecteren
        if (typeof window.Capacitor !== 'undefined' || 
            typeof window.CapacitorWeb !== 'undefined' ||
            (window.webkit && window.webkit.messageHandlers)) {
          isCapacitor = true;
        }
        
        // Check 3: Als we in een WebView zijn (standalone mode)
        if (window.navigator.standalone === true || 
            (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)) {
          isCapacitor = true;
        }
        
        console.log('Callback - Is Capacitor:', isCapacitor, 'Params:', params);
        
        // Als we in een native app zijn, probeer deep link redirect
        if (isCapacitor) {
          var deepLink = 'com.workouttimer.app://callback' + params;
          console.log('Attempting deep link redirect:', deepLink);
          
          // Voor iOS: gebruik window.location direct
          if (isIOS) {
            // Probeer eerst de deep link
            window.location.href = deepLink;
            
            // Fallback: na 1 seconde, als we nog steeds op deze pagina zijn, 
            // probeer de app te openen via Capacitor App plugin of gewoon door te gaan
            setTimeout(function() {
              // Als we nog steeds hier zijn, betekent het dat de deep link niet werkte
              // In dat geval blijven we op deze pagina en laat de app de callback verwerken
              console.log('Deep link may not have worked, staying on callback page');
              // De app zal de URL parameters detecteren en verwerken
            }, 1000);
          } 
          // Voor Android: gebruik intent:// URL
          else if (isAndroid) {
            var intentUrl = 'intent://callback' + params + '#Intent;scheme=com.workouttimer.app;package=com.workouttimer.app;end';
            try {
              window.location.href = intentUrl;
            } catch (e) {
              console.error('Intent URL failed:', e);
              // Fallback naar web
              redirectToWeb();
            }
          }
          else {
            // Andere platformen: probeer deep link
            window.location.href = deepLink;
            setTimeout(redirectToWeb, 2000);
          }
        } else {
          // Web versie: redirect naar main app met params
          redirectToWeb();
        }
        
        function redirectToWeb() {
          // Detect base path from current location
          var pathParts = l.pathname.split('/');
          // Remove empty parts and 'callback'
          pathParts = pathParts.filter(function(part) {
            return part && part !== 'callback';
          });
          var basePath = pathParts.length > 0 ? '/' + pathParts.join('/') + '/' : '/';
          
          // Build redirect URL
          var redirectUrl = l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
            basePath +
            params +
            (l.hash || '');
          
          console.log('Redirecting to web:', redirectUrl);
          l.replace(redirectUrl);
        }
      })();
    </script>
  </head>
  <body>
    <p>Verbinden met Sonos...</p>
    <p style="font-size: 12px; color: #666; margin-top: 20px;">
      Als je niet automatisch wordt doorgestuurd, <a href="#" onclick="window.location.reload(); return false;">klik hier</a>.
    </p>
  </body>
</html>

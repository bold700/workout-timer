<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonos Verbinden - Workout Timer</title>
    <script>
      (function() {
        var l = window.location;
        var params = l.search;
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        var isAndroid = /Android/.test(navigator.userAgent);
        var isMobile = isIOS || isAndroid;
        
        console.log('Callback page loaded', {
          userAgent: navigator.userAgent,
          isIOS: isIOS,
          isAndroid: isAndroid,
          params: params
        });
        
        // ALTIJD proberen deep link te openen op mobile devices
        // Als de app geïnstalleerd is, zal iOS/Android de deep link afhandelen
        if (isMobile) {
          var deepLink = 'com.workouttimer.app://callback' + params;
          console.log('Attempting to open deep link:', deepLink);
          
          // Probeer direct de deep link te openen
          // Op iOS: als de app geïnstalleerd is, opent iOS de app automatisch
          // Op Android: gebruik intent:// URL
          if (isIOS) {
            // iOS: probeer direct deep link
            window.location.href = deepLink;
            
            // Fallback: als de app niet geïnstalleerd is of deep link niet werkt,
            // redirect naar web versie na 2 seconden
            setTimeout(function() {
              // Check of we nog steeds op deze pagina zijn
              // Als de deep link werkte, zijn we al weg
              if (window.location.href.indexOf('callback') !== -1) {
                console.log('Deep link did not work, redirecting to web version');
                redirectToWeb();
              }
            }, 2000);
          } else if (isAndroid) {
            // Android: gebruik intent:// URL
            var intentUrl = 'intent://callback' + params + '#Intent;scheme=com.workouttimer.app;package=com.workouttimer.app;end';
            try {
              window.location.href = intentUrl;
              // Fallback na 2 seconden
              setTimeout(function() {
                if (window.location.href.indexOf('callback') !== -1) {
                  redirectToWeb();
                }
              }, 2000);
            } catch (e) {
              console.error('Intent URL failed:', e);
              redirectToWeb();
            }
          }
        } else {
          // Desktop/Web: redirect naar web versie
          redirectToWeb();
        }
        
        function redirectToWeb() {
          // Detect base path from current location
          var pathParts = l.pathname.split('/');
          // Remove empty parts and 'callback'
          pathParts = pathParts.filter(function(part) {
            return part && part !== 'callback';
          });
          var basePath = pathParts.length > 0 ? '/' + pathParts.join('/') + '/' : '/';
          
          // Build redirect URL
          var redirectUrl = l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
            basePath +
            params +
            (l.hash || '');
          
          console.log('Redirecting to web:', redirectUrl);
          l.replace(redirectUrl);
        }
      })();
    </script>
  </head>
  <body>
    <p>Verbinden met Sonos...</p>
    <p style="font-size: 12px; color: #666; margin-top: 20px;">
      Als je niet automatisch wordt doorgestuurd, <a href="#" onclick="window.location.reload(); return false;">klik hier</a>.
    </p>
  </body>
</html>
